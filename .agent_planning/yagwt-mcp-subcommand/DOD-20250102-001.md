# Definition of Done: yagwt mcp Subcommand

**Created**: 2025-01-02T00:00:00Z
**Target**: Define acceptance criteria for the `yagwt mcp` subcommand implementation

## Core Requirements (Must-Have)

### Functional Requirements

1. **Command Registration**
   - [ ] `yagwt mcp` command is registered and accessible
   - [ ] Command appears in help output with proper description
   - [ ] `--help` flag shows detailed usage information

2. **Default Behavior (Add Configuration)**
   - [ ] `yagwt mcp` adds yagwt MCP server to .mcp.json
   - [ ] Creates .mcp.json if it doesn't exist
   - [ ] Uses proper JSON structure with "mcpServers" key
   - [ ] YAGWT server named "yagwt" in the configuration

3. **Remove Behavior**
   - [ ] `yagwt mcp --rm` removes yagwt MCP server from .mcp.json
   - [ ] Preserves other MCP server configurations
   - [ ] Handles case when yagwt is not configured (no error)

4. **Configuration Preservation**
   - [ ] Existing MCP configurations are preserved when adding yagwt
   - [ ] File ordering and formatting is reasonable (pretty-printed JSON)
   - [ ] Empty .mcp.json files are handled correctly

5. **Error Handling**
   - [ ] Invalid JSON in existing .mcp.json is detected and reported
   - [ ] Does NOT modify files with invalid JSON
   - [ ] Permission errors are handled gracefully
   - [ ] File system errors are reported with clear messages

6. **Validation**
   - [ ] Resulting .mcp.json is validated to be valid JSON
   - [ ] File content verification after writing

### Technical Requirements

7. **Code Quality**
   - [ ] Follows existing yagwt code patterns and conventions
   - [ ] Uses yagwt's error handling and output formatting
   - [ ] Respects global flags (--json, --porcelain, --quiet)
   - [ ] Proper use of Cobra command structure

8. **Binary Path Resolution**
   - [ ] Uses "yagwt" as default command (assumes in PATH)
   - [ ] Attempts to use executable path if running as yagwt binary
   - [ ] Generates correct MCP server configuration structure

### Performance Requirements

9. **Performance**
   - [ ] Command completes in <100ms for typical use cases
   - [ ] No unnecessary file operations
   - [ ] Memory efficient (doesn't load large files unnecessarily)

## Testing Requirements

10. **Unit Test Coverage**
    - [ ] All functions have unit tests
    - [ ] Test coverage ≥ 90% for new code
    - [ ] Tests cover both success and error paths
    - [ ] Edge cases are tested (empty files, invalid JSON, etc.)

11. **Integration Tests**
    - [ ] End-to-end test: add → verify → remove → verify
    - [ ] Test with existing MCP configurations
    - [ ] Test with various file states (missing, empty, invalid)
    - [ ] Verify generated JSON is valid and correctly structured

12. **Manual Verification**
    - [ ] Command works in real environment
    - [ ] Generated .mcp.json works with MCP clients
    - [ ] Error messages are helpful and actionable

## Documentation Requirements

13. **Command Help**
    - [ ] Clear one-line description in command list
    - [ ] Detailed help text with examples
    - [ ] Flags are documented with purpose

14. **Code Documentation**
    - [ ] Public functions have Go doc comments
    - [ ] Complex logic has inline comments
    - [ ] Error conditions are documented

## Acceptance Test Scenarios

### Scenario 1: Fresh Directory
```bash
$ ls -la .mcp.json
ls: .mcp.json: No such file or directory

$ yagwt mcp
✓ yagwt MCP configuration added to .mcp.json

$ cat .mcp.json
{
  "mcpServers": {
    "yagwt": {
      "command": "yagwt",
      "args": ["mcp-server"]
    }
  }
}
```

### Scenario 2: Existing Configuration
```bash
$ cat .mcp.json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": ["@modelcontextprotocol/server-filesystem", "/path/to/files"]
    }
  }
}

$ yagwt mcp
✓ yagwt MCP configuration added to .mcp.json

$ cat .mcp.json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": ["@modelcontextprotocol/server-filesystem", "/path/to/files"]
    },
    "yagwt": {
      "command": "yagwt",
      "args": ["mcp-server"]
    }
  }
}
```

### Scenario 3: Remove Configuration
```bash
# Starting with yagwt configured

$ yagwt mcp --rm
✓ yagwt MCP configuration removed from .mcp.json

# Other configurations preserved
```

### Scenario 4: Invalid JSON
```bash
$ echo '{"invalid": json}' > .mcp.json

$ yagwt mcp
Error: .mcp.json exists but contains invalid JSON
Please fix the JSON or remove the file manually

$ cat .mcp.json
{"invalid": json}  # File unchanged
```

### Scenario 5: Already Configured
```bash
# yagwt already in .mcp.json

$ yagwt mcp
ℹ yagwt MCP configuration already exists in .mcp.json
```

### Scenario 6: Empty/Whitespace File
```bash
$ echo '   ' > .mcp.json

$ yagwt mcp
✓ yagwt MCP configuration added to .mcp.json

$ cat .mcp.json
{
  "mcpServers": {
    "yagwt": {
      "command": "yagwt",
      "args": ["mcp-server"]
    }
  }
}
```

## Non-Functional Requirements

### Usability
- [ ] Error messages provide clear guidance on resolution
- [ ] Success messages confirm what was done
- [ ] Command follows Unix conventions for exit codes

### Maintainability
- [ ] Code is modular and testable
- [ ] No hardcoded paths or values that could change
- [ ] Uses standard Go libraries where possible

### Compatibility
- [ ] Works on all platforms yagwt supports (Linux, macOS, Windows)
- [ ] Handles different line endings correctly
- [ ] Respects file permissions and umask

## Exit Code Requirements

- `0` (ExitSuccess): Operation completed successfully (including no-op cases)
- `1` (ExitFailure): General errors (file system, permission, etc.)
- `2` (ExitInvalidUsage): Invalid command usage (shouldn't occur with this command)

## Performance Benchmarks

| Operation | Target Time | Measurement Method |
|-----------|-------------|-------------------|
| Add to new file | <50ms | time command |
| Add to existing file | <100ms | time command |
| Remove configuration | <50ms | time command |
| Check existing config | <20ms | time command |

## Security Considerations

- [ ] Does not create files with overly permissive permissions
- [ ] Does not execute external commands based on file content
- [ ] Validates all inputs and file contents
- [ ] Handles symlinks safely (doesn't follow malicious symlinks)

## Definition of Complete

The implementation is considered complete when:

1. All **Core Requirements** (1-9) are satisfied
2. All **Testing Requirements** (10-12) are met
3. All **Documentation Requirements** (13-14) are fulfilled
4. All **Acceptance Test Scenarios** pass
5. Code review approves the implementation
6. The feature works in a real environment with actual MCP clients

## Verification Checklist

Before marking as complete:

- [ ] Run all unit tests: `go test ./internal/cli/commands/...`
- [ ] Run integration tests: `go test -tags=integration ./...`
- [ ] Manual testing in clean directory
- [ ] Manual testing with existing .mcp.json
- [ ] Test with various error conditions
- [ ] Verify with actual MCP client (if available)
- [ ] Check code formatting: `go fmt ./...`
- [ ] Run linter: `golangci-lint run`
- [ ] Verify help text: `yagwt mcp --help`
- [ ] Test global flags: `yagwt --json mcp`, `yagwt --quiet mcp`, etc.