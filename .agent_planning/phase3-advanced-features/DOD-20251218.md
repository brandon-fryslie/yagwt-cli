# Definition of Done: Phase 3 Advanced Features

**Topic**: Advanced Features (Cleanup, Doctor, Filters)
**Created**: 2024-12-18

## Acceptance Criteria

### Filter Engine (`internal/filter/`)

- [ ] `ParseFilter("flag:pinned")` parses flag filter correctly
- [ ] `ParseFilter("status:dirty")` parses status filter correctly
- [ ] `ParseFilter("target:branch")` parses target filter correctly
- [ ] `ParseFilter("activity:idle>30d")` parses activity filter correctly
- [ ] `ParseFilter("name:feature-*")` parses name filter with glob
- [ ] `ParseFilter("branch:main")` parses branch filter correctly
- [ ] `ParseFilter("flag:pinned,status:clean")` parses AND logic (comma)
- [ ] `ParseFilter("flag:pinned|flag:ephemeral")` parses OR logic (pipe)
- [ ] `ParseFilter("invalid")` returns E_CONFIG error
- [ ] `Match()` correctly evaluates each filter type against workspaces
- [ ] Unit tests cover all filter types and combinations

### Cleanup Policy Engine (`internal/cleanup/`)

- [ ] `GetPolicy("default")` returns default policy
- [ ] `GetPolicy("conservative")` returns conservative policy
- [ ] `GetPolicy("aggressive")` returns aggressive policy
- [ ] Default policy removes expired ephemeral workspaces
- [ ] Default policy removes idle >30d non-pinned workspaces
- [ ] Default policy skips pinned/locked workspaces
- [ ] Conservative policy only removes expired ephemeral
- [ ] Aggressive policy removes idle >7d workspaces
- [ ] `GeneratePlan()` produces correct removal candidates
- [ ] Plan includes reasons for each removal
- [ ] Plan warnings for potentially risky removals
- [ ] Unit tests cover all policies

### On-Dirty Strategies (`internal/core/`)

- [ ] `Remove()` with OnDirty="fail" fails on dirty workspace
- [ ] `Remove()` with OnDirty="force" removes dirty workspace
- [ ] `Remove()` with OnDirty="stash" runs git stash before removal
- [ ] `Remove()` with OnDirty="patch" creates patch file
- [ ] `Remove()` with OnDirty="wip-commit" creates WIP commit
- [ ] Stash strategy uses meaningful stash message
- [ ] Patch strategy exports both staged and unstaged changes
- [ ] WIP-commit strategy uses custom message if provided
- [ ] On-dirty errors are wrapped with hints
- [ ] Integration tests verify strategies work with real git

### Cleanup Integration

- [ ] `engine.Cleanup(policy)` generates cleanup plan
- [ ] `engine.Cleanup(dryRun=true)` doesn't remove anything
- [ ] `engine.Cleanup(dryRun=false)` executes removals
- [ ] Cleanup respects on-dirty setting
- [ ] Cleanup returns CleanupPlan with all actions
- [ ] Partial failures don't stop remaining removals
- [ ] Integration tests verify full cleanup flow

### Doctor/Repair (`internal/core/`)

- [ ] `engine.Doctor()` detects metadata for missing worktree
- [ ] `engine.Doctor()` detects worktree without metadata
- [ ] `engine.Doctor()` detects stale index entries
- [ ] `engine.Doctor(forgetMissing=true)` removes orphaned metadata
- [ ] `engine.Doctor()` creates metadata for untracked worktrees
- [ ] `engine.Doctor()` rebuilds corrupted indexes
- [ ] `engine.Doctor(dryRun=true)` reports but doesn't fix
- [ ] DoctorReport lists all issues found
- [ ] DoctorReport lists all repairs applied
- [ ] Integration tests verify doctor with real broken states

### Overall Quality

- [ ] All tests pass (`go test ./...`)
- [ ] Code compiles without warnings (`go build ./...`)
- [ ] 90%+ test coverage for new packages (filter, cleanup)
- [ ] Integration tests with real git repos pass
- [ ] No race conditions (`go test -race`)

## Sprint Scope

**Deliverables**:
1. Filter engine with parse and match
2. Cleanup policy engine with 3 built-in policies
3. On-dirty strategies (stash, patch, wip-commit)
4. Doctor detection and repair
5. Comprehensive unit and integration tests

## Out of Scope (Phase 4+)

- CLI commands (clean, doctor, filter flags)
- Custom policy configuration in config files
- Hook execution on cleanup
- Interactive confirmation prompts
