# Phase 4: CLI Commands - Implementation Plan

**Topic**: CLI Commands (User Interface)
**Created**: 2024-12-18
**Status**: Ready for Implementation

## Overview

Phase 4 implements the complete CLI command surface for YAGWT using Cobra. This makes the core engine accessible to users through a well-designed command-line interface.

## Dependencies

Add to go.mod:
```go
require (
    github.com/spf13/cobra v1.8.0
)
```

## Command Structure

```
yagwt
├── ls            # List workspaces
├── show          # Show workspace details
├── path          # Print workspace path
├── resolve       # Resolve selector to workspace(s)
├── new           # Create new workspace
├── rm            # Remove workspace
├── rename        # Rename workspace
├── pin           # Pin workspace
├── unpin         # Unpin workspace
├── lock          # Lock workspace
├── unlock        # Unlock workspace
├── ephemeral     # Mark workspace as ephemeral
├── permanent     # Mark workspace as permanent
├── clean         # Cleanup stale workspaces
├── doctor        # Diagnose and repair issues
└── version       # Show version
```

## Components to Implement

### 1. Root Command (`cmd/yagwt/main.go`, `internal/cli/commands/root.go`)

#### 1.1 Global Flags
```
--repo, -r      Path to git repository (default: current directory)
--json          Output in JSON format
--porcelain     Output in machine-parseable format
--quiet, -q     Suppress non-essential output
--no-prompt     Never prompt for confirmation
--yes, -y       Assume yes for confirmations
--config        Path to config file
--version       Print version and exit
--help          Print help
```

#### 1.2 Root Setup
- Initialize Cobra app
- Set up persistent pre-run hook to find repo
- Configure error handling with exit codes
- Set up output formatters based on flags

### 2. List Command (`ls`)

**Usage**: `yagwt ls [flags] [filter]`

**Flags**:
```
--all, -a       Show all workspaces (including broken)
--filter, -f    Filter expression (e.g., "flag:pinned")
--fields        Fields to show (name,path,branch,status)
--sort          Sort by field (name, path, activity)
```

**Implementation**:
- Call `engine.List(ListOptions{Filter: filter})`
- Format output based on --json/--porcelain flags
- Handle empty results gracefully

### 3. Show Command (`show`)

**Usage**: `yagwt show <selector>`

**Implementation**:
- Parse selector from argument
- Call `engine.Get(selector)`
- Display all workspace details in formatted output
- Support --json for full JSON dump

### 4. Path Command (`path`)

**Usage**: `yagwt path <selector>`

**Implementation**:
- Parse selector
- Call `engine.Get(selector)`
- Print just the path (for scripting: `cd $(yagwt path auth)`)

### 5. Resolve Command (`resolve`)

**Usage**: `yagwt resolve <selector>`

**Implementation**:
- Parse selector
- Call `engine.Resolve(selector)`
- Print all matching workspaces
- Useful for debugging selector ambiguity

### 6. New Command (`new`)

**Usage**: `yagwt new <target> [flags]`

**Flags**:
```
--name, -n      Workspace name (default: derived from target)
--dir, -d       Directory path (default: derived from config)
--base, -b      Base branch for new branch
--new-branch    Create new branch from target
--detach        Create detached HEAD
--ephemeral     Mark as ephemeral
--ttl           TTL for ephemeral (e.g., "7d", "24h")
--pin           Pin immediately
--no-checkout   Don't checkout after creation
```

**Implementation**:
- Parse target (branch name or commit)
- Build CreateOptions from flags
- Call `engine.Create(opts)`
- Print created workspace info

### 7. Remove Command (`rm`)

**Usage**: `yagwt rm <selector> [flags]`

**Flags**:
```
--delete-branch     Also delete the branch
--keep-branch       Keep the branch (default)
--on-dirty          Strategy: fail, stash, patch, wip-commit, force
--patch-dir         Directory for patches (with --on-dirty=patch)
--wip-message       WIP commit message (with --on-dirty=wip-commit)
--force, -f         Shortcut for --on-dirty=force
```

**Implementation**:
- Parse selector
- Build RemoveOptions from flags
- If workspace is dirty and interactive, prompt for strategy
- Call `engine.Remove(selector, opts)`
- Print confirmation

### 8. Rename Command (`rename`)

**Usage**: `yagwt rename <selector> <new-name>`

**Implementation**:
- Parse selector and new name
- Call `engine.Rename(selector, newName)`
- Print confirmation

### 9. Pin/Unpin Commands

**Usage**: `yagwt pin <selector>`, `yagwt unpin <selector>`

**Implementation**:
- Parse selector
- Call `engine.Pin(selector)` or `engine.Unpin(selector)`
- Print confirmation

### 10. Lock/Unlock Commands

**Usage**: `yagwt lock <selector>`, `yagwt unlock <selector>`

**Implementation**:
- Parse selector
- Call `engine.Lock(selector)` or `engine.Unlock(selector)`
- Print confirmation

### 11. Ephemeral/Permanent Commands

**Usage**: `yagwt ephemeral <selector> [--ttl duration]`, `yagwt permanent <selector>`

**Implementation**:
- Parse selector
- Update workspace flags and TTL
- Print confirmation

### 12. Clean Command

**Usage**: `yagwt clean [flags]`

**Flags**:
```
--policy        Policy: default, conservative, aggressive
--dry-run       Show plan without executing
--apply         Execute the cleanup
--on-dirty      Strategy for dirty workspaces
--max           Maximum workspaces to remove
```

**Implementation**:
- Build CleanupOptions from flags
- If no --apply, default to dry-run
- Call `engine.Cleanup(opts)`
- Display plan/results

### 13. Doctor Command

**Usage**: `yagwt doctor [flags]`

**Flags**:
```
--dry-run           Show issues without fixing
--forget-missing    Remove metadata for missing worktrees
```

**Implementation**:
- Build DoctorOptions from flags
- Call `engine.Doctor(opts)`
- Display report

### 14. Version Command

**Usage**: `yagwt version` or `yagwt --version`

**Implementation**:
- Print version, build date, commit SHA
- Support --json for structured output

## Output Formatting

### Human Output
- Tables with aligned columns
- Color-coded status indicators (optional, respect NO_COLOR)
- Clear headers and separators

### JSON Output
- Include schemaVersion field
- Consistent structure across commands
- Pretty-printed by default, compact with --quiet

### Porcelain Output
- Tab-separated values
- No headers
- Stable column order (documented)

## Error Handling

### Exit Codes
- 0: Success
- 1: Generic failure
- 2: Invalid usage / ambiguous selector
- 3: Safety refusal (dirty + non-interactive)
- 4: Partial success (batch operations)
- 5: Not found

### Error Display
- Human: Colored error message with hints
- JSON: Error envelope with code, message, details, hints
- Porcelain: Error code and message

## File Structure

```
cmd/yagwt/
└── main.go           # Entry point, version info

internal/cli/
├── commands/
│   ├── root.go       # Root command, global flags
│   ├── ls.go         # List command
│   ├── show.go       # Show command
│   ├── path.go       # Path command
│   ├── resolve.go    # Resolve command
│   ├── new.go        # New command
│   ├── rm.go         # Remove command
│   ├── rename.go     # Rename command
│   ├── pin.go        # Pin/unpin commands
│   ├── lock.go       # Lock/unlock commands
│   ├── ephemeral.go  # Ephemeral/permanent commands
│   ├── clean.go      # Clean command
│   ├── doctor.go     # Doctor command
│   └── version.go    # Version command
└── output/
    ├── formatter.go  # Output formatting interface
    ├── human.go      # Human-readable formatter
    ├── json.go       # JSON formatter
    └── porcelain.go  # Porcelain formatter
```

## Implementation Order

1. **Root command and global flags**
2. **Output formatters** (needed by all commands)
3. **Version command** (simplest, validates setup)
4. **List command** (most used, read-only)
5. **Show/path/resolve commands** (read-only)
6. **New command** (create)
7. **Remove command** (delete)
8. **Pin/unpin, lock/unlock** (modify)
9. **Rename command** (modify)
10. **Clean command** (maintenance)
11. **Doctor command** (maintenance)
12. **Ephemeral/permanent commands** (modify)

## Testing Strategy

### Unit Tests
- Test flag parsing for each command
- Test output formatting
- Test error handling

### E2E Tests
- Create temp git repos
- Run CLI commands
- Verify output and side effects
- Test all exit codes

## Success Criteria

See `DOD-20251218.md` for acceptance criteria.
