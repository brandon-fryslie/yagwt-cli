# Definition of Done: Phase 1 Foundation

**Topic**: Foundation (Core Infrastructure)
**Created**: 2024-12-18

## Acceptance Criteria

### Git Wrapper (`internal/git/`)

- [ ] `NewRepository(path)` correctly finds repo root from any subdirectory
- [ ] `NewRepository(path)` returns E_GIT error when not in a git repo
- [ ] `ListWorktrees()` parses `git worktree list --porcelain` output correctly
- [ ] `ListWorktrees()` handles detached HEAD, locked, and prunable states
- [ ] `AddWorktree()` creates worktrees for existing branches
- [ ] `AddWorktree()` creates worktrees with new branches (`--track`)
- [ ] `AddWorktree()` creates detached worktrees for commits
- [ ] `RemoveWorktree()` removes worktrees (normal and forced)
- [ ] `GetStatus()` parses dirty, conflicts, ahead/behind from porcelain v2
- [ ] `ResolveRef()` returns full SHA for valid refs, E_NOT_FOUND for invalid
- [ ] Unit tests pass for all parsing logic
- [ ] Integration tests pass with real git repos

### Metadata Storage (`internal/metadata/`)

- [ ] `NewStore(gitDir)` creates `<gitDir>/yagwt/` directory if missing
- [ ] `Load()` reads metadata from JSON file
- [ ] `Load()` returns empty metadata with schema v1 if file missing
- [ ] `Load()` returns E_CONFIG error on corrupted JSON
- [ ] `Get(id)`, `FindByName()`, `FindByPath()` use index for O(1) lookup
- [ ] `Save()` writes atomically (temp file + rename)
- [ ] `Set()` updates single workspace and indexes
- [ ] `Delete()` removes workspace and cleans indexes
- [ ] `RebuildIndex()` rebuilds all indexes from workspace data
- [ ] Unit tests cover all CRUD operations
- [ ] Unit tests verify atomic write behavior

### Lock Manager (`internal/lock/`)

- [ ] `NewLock(path)` creates lock instance (doesn't acquire)
- [ ] `Acquire(timeout)` uses flock/fcntl for advisory locking
- [ ] `Acquire()` times out after specified duration, returns E_LOCKED
- [ ] `Acquire()` succeeds when lock is available
- [ ] `Release()` releases the lock correctly
- [ ] Concurrent `Acquire()` calls block appropriately
- [ ] Unit tests verify locking behavior

### Config Loader (`internal/config/`)

- [ ] `Load()` searches config locations in correct precedence order
- [ ] `Load()` parses TOML config files correctly
- [ ] `Load()` merges config with defaults (config wins)
- [ ] `Load()` validates `rootStrategy` (sibling/inside)
- [ ] `Load()` validates `onDirty` values
- [ ] `Load()` returns E_CONFIG on invalid config
- [ ] `DefaultConfig()` returns sensible defaults
- [ ] Unit tests cover parsing, merging, and validation

### Error Model (`internal/core/`)

- [ ] Errors can wrap underlying errors while preserving chain
- [ ] All error codes map to correct exit codes
- [ ] Errors serialize to JSON correctly
- [ ] Hints are preserved in serialization

### Overall Quality

- [ ] All tests pass (`go test ./...`)
- [ ] Code compiles without warnings (`go build ./...`)
- [ ] No obvious race conditions in locking code
- [ ] 90%+ test coverage for implemented packages (measured with `go test -cover`)

## Sprint Scope

**Deliverables**:
1. Fully implemented git wrapper with worktree operations
2. Atomic metadata storage with indexing
3. Advisory file locking with timeout
4. TOML config loading with precedence and validation

## Out of Scope (Phase 2+)

- WorkspaceManager integration
- CLI commands
- Cleanup policies
- Filter language
