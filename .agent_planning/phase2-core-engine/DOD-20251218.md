# Definition of Done: Phase 2 Core Engine

**Topic**: Core Engine (Business Logic)
**Created**: 2024-12-18

## Acceptance Criteria

### Selector System (`internal/core/selector.go`)

- [ ] `ParseSelector("id:abc123")` returns SelectorID with value "abc123"
- [ ] `ParseSelector("name:my-feature")` returns SelectorName with value "my-feature"
- [ ] `ParseSelector("path:/abs/path")` returns SelectorPath with normalized absolute path
- [ ] `ParseSelector("branch:feature/x")` returns SelectorBranch with value "feature/x"
- [ ] `ParseSelector("bare-value")` returns SelectorBare with value "bare-value"
- [ ] Path selectors normalize relative paths to absolute
- [ ] Unit tests cover all selector types

### Engine Initialization (`internal/core/engine.go`)

- [ ] `NewEngine(path)` finds git repo from any subdirectory
- [ ] `NewEngine(path)` returns E_GIT error when not in git repo
- [ ] `NewEngine(path)` creates metadata store in `<gitDir>/yagwt/`
- [ ] `NewEngine(path)` loads configuration
- [ ] `NewEngineWithDeps()` enables testing with mocked dependencies

### List Operation

- [ ] `List()` returns all workspaces with merged git + metadata
- [ ] `List()` includes git status (dirty, conflicts, ahead/behind)
- [ ] `List()` correctly identifies primary workspace
- [ ] `List()` marks workspaces with missing git worktree as broken
- [ ] `List()` with empty repo returns empty slice (not error)
- [ ] Unit tests cover merging logic

### Get Operation

- [ ] `Get(selector)` returns workspace for valid selector
- [ ] `Get(selector)` returns E_NOT_FOUND for missing workspace
- [ ] `Get(selector)` returns E_AMBIGUOUS for ambiguous bare selector
- [ ] Unit tests cover all resolution cases

### Create Operation

- [ ] `Create()` creates git worktree at specified path
- [ ] `Create()` creates git worktree at derived path (sibling strategy)
- [ ] `Create()` creates git worktree at derived path (inside strategy)
- [ ] `Create()` assigns unique workspace ID
- [ ] `Create()` sets workspace name (from opts or derived from branch)
- [ ] `Create()` handles --detach for creating detached worktrees
- [ ] `Create()` handles new branch creation
- [ ] `Create()` sets ephemeral flag and TTL when opts.Ephemeral=true
- [ ] `Create()` sets pinned flag when opts.Pin=true
- [ ] `Create()` persists metadata atomically
- [ ] `Create()` returns E_GIT on git errors
- [ ] `Create()` returns E_CONFLICT if path already exists
- [ ] Unit tests cover path derivation
- [ ] Integration tests verify actual worktree creation

### Remove Operation

- [ ] `Remove(selector)` resolves selector to workspace
- [ ] `Remove(selector)` removes git worktree
- [ ] `Remove(selector)` removes metadata entry
- [ ] `Remove()` with opts.OnDirty="fail" fails on dirty workspace
- [ ] `Remove()` with opts.OnDirty="force" removes dirty workspace
- [ ] `Remove()` on pinned workspace returns E_LOCKED
- [ ] `Remove()` on locked workspace returns E_LOCKED
- [ ] `Remove()` returns E_NOT_FOUND for missing workspace
- [ ] Unit tests cover all dirty handling cases
- [ ] Integration tests verify actual worktree removal

### Rename Operation

- [ ] `Rename(selector, newName)` updates workspace name
- [ ] `Rename()` returns E_CONFLICT if new name already exists
- [ ] `Rename()` updates name index
- [ ] `Rename()` persists atomically

### Pin/Unpin Operations

- [ ] `Pin(selector)` sets Flags.Pinned = true
- [ ] `Unpin(selector)` sets Flags.Pinned = false
- [ ] Changes are persisted to metadata

### Lock/Unlock Operations

- [ ] `Lock(selector)` sets Flags.Locked = true
- [ ] `Unlock(selector)` sets Flags.Locked = false
- [ ] Changes are persisted to metadata

### Move Operation

- [ ] `Move(selector, newPath)` moves worktree to new location
- [ ] `Move()` updates metadata path
- [ ] `Move()` returns E_CONFLICT if destination exists
- [ ] Note: Move is complex, may be deferred to Phase 3 if needed

### Resolve Operation

- [ ] `Resolve("id:abc123")` returns exact ID match
- [ ] `Resolve("name:my-feature")` returns exact name match
- [ ] `Resolve("path:/abs/path")` returns exact path match
- [ ] `Resolve("branch:feature/x")` returns all workspaces on branch
- [ ] `Resolve("bare")` tries id → name → path → branch in order
- [ ] `Resolve()` returns empty slice for no matches
- [ ] `Resolve()` returns multiple for ambiguous matches

### Overall Quality

- [ ] All tests pass (`go test ./...`)
- [ ] Code compiles without warnings (`go build ./...`)
- [ ] 90%+ test coverage for core package (measured with `go test -cover`)
- [ ] Integration tests with real git repos pass
- [ ] No race conditions (tested with `go test -race`)

## Sprint Scope

**Deliverables**:
1. Complete selector system with parsing and resolution
2. WorkspaceManager with List, Get, Create, Remove
3. Lifecycle operations (Pin/Unpin, Lock/Unlock, Rename)
4. Move operation (if time permits, else Phase 3)
5. Comprehensive unit and integration tests

## Out of Scope (Phase 3+)

- Cleanup policy engine
- Doctor/repair
- Filter engine
- On-dirty strategies beyond fail/force (stash, patch, wip-commit)
- CLI commands
